<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>BET300 ¬∑ Beneficio Progresivo</title>
<meta name="theme-color" content="#070a14"/>

<style>
:root{
  --bg:#070a14;
  --bg2:#0b1020;

  --panel: rgba(255,255,255,.06);
  --panel2: rgba(255,255,255,.04);

  --border: rgba(255,255,255,.10);
  --border2: rgba(255,255,255,.16);

  --text:#eef2ff;
  --muted:#b7c0e6;
  --muted2:#93a0d7;

  --gold:#f5d37b;

  --red:#ff2d2d;
  --wa:#25D366;

  --shadow: 0 18px 60px rgba(0,0,0,.55);
  --shadow2: 0 14px 30px rgba(0,0,0,.35);

  --radius: 18px;
  --radius2: 22px;

  --maxw: 1080px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  font: 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
  background:
    radial-gradient(900px 520px at 15% -10%, rgba(255,45,45,.20), transparent 60%),
    radial-gradient(900px 520px at 92% 0%, rgba(245,211,123,.16), transparent 56%),
    radial-gradient(980px 640px at 60% 120%, rgba(140,160,255,.12), transparent 55%),
    linear-gradient(180deg, var(--bg) 0%, var(--bg2) 55%, #070a14 100%);
  overflow-x:hidden;
}

.fx{position:fixed; inset:0; z-index:-1; pointer-events:none; opacity:.75;}
.fx canvas{width:100%; height:100%; display:block}

.container{max-width:var(--maxw); margin:14px auto 96px; padding:0 12px;}
.shell{
  border:1px solid var(--border);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border-radius: var(--radius2);
  box-shadow: var(--shadow);
  overflow:hidden;
}

/* ===================== HEADER (UNA L√çNEA) ===================== */
.topbar{
  display:flex; align-items:center; gap:10px;
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,.08);
  background:
    radial-gradient(120% 120% at 10% 0%, rgba(255,45,45,.22), transparent 55%),
    radial-gradient(120% 120% at 90% 0%, rgba(245,211,123,.18), transparent 55%),
    rgba(0,0,0,.18);
  backdrop-filter: blur(12px);
}

/* Logo m√°s visible */
.logo{
  width:64px; height:44px;  /* + grande */
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.20);
  box-shadow: 0 10px 26px rgba(0,0,0,.35);
  overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  flex: 0 0 auto;
}
.logo img{
  width:100%; height:100%;
  object-fit:contain;
  padding:4px; /* menos padding, se ve mejor */
  display:block;
}
.logoFallback{
  display:none;
  font-weight:1000;
  font-size:12px;
  letter-spacing:.12em;
  color:var(--gold);
}
.logo.is-fallback img{display:none}
.logo.is-fallback .logoFallback{display:block}

/* Texto marca (compacto) */
.brandTxt{
  display:flex;
  flex-direction:column;
  gap:0;
  line-height:1.05;
  min-width: 90px;
}
.brandTxt b{font-size:14px; letter-spacing:.6px}
.brandTxt span{font-size:11px; color:var(--muted2); letter-spacing:.18em; text-transform:uppercase}

/* Pills compactas a la derecha */
.pills{
  display:flex; align-items:center; gap:8px;
  margin-left:auto;
  flex-wrap:nowrap;
}
.pill{
  display:inline-flex; align-items:center; gap:7px;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  color: var(--muted);
  font-size:12px;
  white-space:nowrap;
}
.pill strong{color:var(--text); font-variant-numeric: tabular-nums}
.pill.btnlike{cursor:pointer; user-select:none}
.pill:hover{border-color: rgba(255,255,255,.18)}

/* En pantallas muy chicas: oculto el texto "Tiempo limitado" y dejo solo el contador */
@media(max-width:420px){
  .brandTxt span{display:none}
  .pill .lbl{display:none}
  .logo{width:58px; height:40px}
}

/* ===================== LAYOUT ===================== */
.grid{
  display:grid;
  grid-template-columns: 1.12fr .88fr;
  gap: 12px;
  padding: 12px;
}
@media(max-width:940px){ .grid{grid-template-columns:1fr;} }

.panel{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
  border-radius: var(--radius);
  box-shadow: 0 12px 30px rgba(0,0,0,.25);
  overflow:hidden;
}
.panel .inner{padding: 14px}

.panelTitle{
  display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  margin-bottom:10px;
}
.panelTitle h1{margin:0; font-size:22px; letter-spacing:.2px}
.panelTitle p{margin:6px 0 0; color:var(--muted); font-size:13px}
.badgeLux{
  display:inline-flex; align-items:center; gap:8px;
  padding: 8px 10px;
  border-radius: 999px;
  border:1px solid rgba(245,211,123,.25);
  background: rgba(245,211,123,.08);
  color: var(--gold);
  font-weight:900;
  font-size:12px;
  white-space:nowrap;
}

.hero{
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(120% 120% at 15% 0%, rgba(255,45,45,.18), transparent 55%),
    radial-gradient(120% 120% at 92% 10%, rgba(245,211,123,.14), transparent 55%),
    radial-gradient(80% 80% at 50% 120%, rgba(120,150,255,.10), transparent 55%),
    rgba(255,255,255,.03);
  border-radius: 18px;
  padding: 14px;
  position:relative;
  overflow:hidden;
}
.hero:before{
  content:"";
  position:absolute; inset:-1px;
  background: linear-gradient(120deg, rgba(255,45,45,.22), rgba(245,211,123,.14), rgba(120,150,255,.12));
  opacity:.18;
  filter: blur(18px);
  pointer-events:none;
}
.hero > *{position:relative; z-index:1;}

.row2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
@media(max-width:560px){ .row2{grid-template-columns:1fr} }

.kpi{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  border-radius: 16px;
  padding: 12px;
  transition: transform .12s ease, border-color .12s ease;
}
.kpi:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.16);}
.kpi .k{color:var(--muted2); font-size:12px}
.kpi .v{font-size:19px; font-weight:1000; margin-top:4px}
.kpi .sub{color:var(--muted); font-size:12px; margin-top:3px}

.selector{
  margin-top:12px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.20);
  border-radius: 18px;
  padding: 12px;
}
.selectorHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
.selectorHead .left b{display:block; font-size:14px}
.selectorHead .left span{display:block; font-size:12px; color:var(--muted)}

.tierPills{display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;}
.tier{
  padding:7px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  font-size:12px;
  color: var(--muted);
  cursor:pointer;
  user-select:none;
  transition: transform .08s ease, border-color .12s ease, background .12s ease;
}
.tier:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.16);}
.tier.active{
  border-color: rgba(245,211,123,.30);
  background: rgba(245,211,123,.10);
  color: var(--gold);
  font-weight:1000;
}

.rangeWrap{margin-top:6px;}
input[type="range"]{width:100%; accent-color: var(--red);}

.scale{
  display:flex; justify-content:space-between;
  font-size:11px; color:var(--muted2);
  margin-top:6px;
}
.progress{
  margin-top:10px;
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  overflow:hidden;
}
.progress > i{
  display:block; height:100%;
  width: 30%;
  background: linear-gradient(90deg, rgba(255,45,45,.95), rgba(245,211,123,.85));
  border-radius:999px;
}

.note{
  margin-top:12px;
  border:1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.03);
  border-radius: 16px;
  padding: 12px;
  color: var(--muted);
  font-size:12px;
}
.note b{color:var(--text)}

/* Right summary */
.summaryCard{display:grid; gap:10px;}
.big{
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(120% 120% at 30% 0%, rgba(255,45,45,.14), transparent 55%),
    radial-gradient(120% 120% at 90% 20%, rgba(245,211,123,.12), transparent 55%),
    rgba(0,0,0,.20);
  border-radius: 18px;
  padding: 14px;
}
.big h2{margin:0; font-size:16px; letter-spacing:.2px}
.big .desc{margin-top:6px; color:var(--muted); font-size:13px}
.big .line{
  margin-top:10px;
  display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
  color: var(--muted2);
  font-size:12px;
}
.big .line b{color:var(--text)}
.codeBox{
  margin-top:10px;
  border-radius: 14px;
  border:1px dashed rgba(255,255,255,.18);
  background: rgba(0,0,0,.18);
  padding: 10px;
  font-variant-numeric: tabular-nums;
  color: var(--muted);
  font-size:12px;
}
.codeBox b{color:var(--text)}

/* Dock */
.dock{
  position:fixed;
  left:0; right:0; bottom:0;
  z-index:50;
  padding: 10px 12px 14px;
  background: linear-gradient(180deg, rgba(7,10,20,0) 0%, rgba(7,10,20,.72) 25%, rgba(7,10,20,.92) 100%);
  backdrop-filter: blur(12px);
}
.dockInner{
  max-width: var(--maxw);
  margin: 0 auto;
  display:flex; gap:10px;
}
.btn{
  width:100%;
  border:none;
  border-radius: 16px;
  padding: 14px 14px;
  font-weight:1000;
  cursor:pointer;
  box-shadow: var(--shadow2);
  transition: transform .08s ease, filter .08s ease;
}
.btn:hover{transform: translateY(-1px); filter: brightness(1.04)}
.btn:active{transform: translateY(0)}
.btn:disabled{opacity:.55; cursor:not-allowed; filter:none; transform:none}

.btn.claim{background: linear-gradient(90deg, var(--wa), #7CFFB1); color:#07110a;}
.btn.enter{background: linear-gradient(90deg, rgba(255,45,45,.98), rgba(255,75,75,.96)); color:#12060a;}
.btn.ghost{
  background: rgba(255,255,255,.06);
  color: var(--text);
  border:1px solid rgba(255,255,255,.12);
  box-shadow: none;
}

.toast{
  position:fixed; left:50%; bottom:92px;
  transform: translateX(-50%);
  background: rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.14);
  padding: 10px 12px;
  border-radius: 999px;
  color: var(--muted);
  font-size:12px;
  opacity:0; pointer-events:none;
  transition: opacity .18s ease, transform .18s ease;
  backdrop-filter: blur(10px);
  z-index:80;
}
.toast.show{opacity:1; transform: translateX(-50%) translateY(-6px);}

/* Modal */
.modal{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  background: rgba(0,0,0,.55);
  z-index:100;
  padding: 18px;
  backdrop-filter: blur(6px);
}
.modal.show{display:flex}
.modalCard{
  width: min(520px, 92vw);
  border-radius: 18px;
  border:1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(120% 120% at 30% 0%, rgba(255,45,45,.16), transparent 55%),
    radial-gradient(120% 120% at 90% 20%, rgba(245,211,123,.14), transparent 55%),
    rgba(10,12,22,.88);
  box-shadow: 0 24px 70px rgba(0,0,0,.60);
  overflow:hidden;
}
.modalHead{
  display:flex; align-items:center; gap:10px;
  padding: 14px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.modalHead h3{margin:0; font-size:16px}
.modalHead .x{
  margin-left:auto;
  width:38px; height:38px;
  border-radius: 12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  display:grid; place-items:center;
  cursor:pointer;
  user-select:none;
}
.modalBody{padding:14px}
.modalRow{
  display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
  border:1px dashed rgba(255,255,255,.16);
  background: rgba(0,0,0,.18);
  border-radius: 14px;
  padding: 10px;
  margin-bottom:10px;
}
.modalRow .k{color:var(--muted2); font-size:12px}
.modalRow .v{font-weight:1000}
.modalActions{display:flex; gap:10px; margin-top:10px}
.modalActions .btn{box-shadow:none}

@media(max-width:640px){
  .dockInner{flex-direction:column}
}
</style>
</head>

<body>
<div class="fx" aria-hidden="true"><canvas id="fx"></canvas></div>
<div id="toast" class="toast"></div>

<div class="container">
  <div class="shell">
    <!-- HEADER COMPACTO -->
    <div class="topbar">
      <div class="logo" id="logoBox" title="Logo BET300">
        <img id="logoImg" src="logo.svg" alt="BET300"/>
        <div class="logoFallback">BET300</div>
      </div>

      <div class="brandTxt">
        <b>BET300</b>
        <span>beneficio progresivo</span>
      </div>

      <div class="pills">
        <span class="pill">
          ‚è≥ <span class="lbl">Tiempo limitado:</span> <strong id="countdown">--:--</strong>
        </span>
        <span class="pill btnlike" id="soundToggle">
          üîä <span class="lbl">Sonido:</span> <strong id="soundState">ON</strong>
        </span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <section class="panel">
        <div class="inner">
          <div class="panelTitle">
            <div>
              <h1>Beneficio Progresivo</h1>
              <p>Eleg√≠ tu nivel seg√∫n tu carga. Se genera un c√≥digo de activaci√≥n.</p>
            </div>
            <div class="badgeLux" id="luxTag">‚ö° 1 chance por d√≠a</div>
          </div>

          <div class="hero">
            <div class="row2">
              <div class="kpi">
                <div class="k">Monto seleccionado</div>
                <div class="v" id="kAmount">$ 10.000</div>
                <div class="sub">Ajustalo seg√∫n el usuario</div>
              </div>
              <div class="kpi">
                <div class="k">Beneficio estimado</div>
                <div class="v" id="kBenefit">+20%</div>
                <div class="sub" id="kHint">Nivel Base ¬∑ Activaci√≥n r√°pida</div>
              </div>
            </div>

            <div class="selector">
              <div class="selectorHead">
                <div class="left">
                  <b>Eleg√≠ tu escala</b>
                  <span>M√°s carga ‚Üí mejor beneficio (sin azar)</span>
                </div>
                <div class="tierPills" id="tierPills">
                  <div class="tier active" data-tier="base">Base</div>
                  <div class="tier" data-tier="pro">Pro</div>
                  <div class="tier" data-tier="max">Max</div>
                </div>
              </div>

              <div class="rangeWrap">
                <input id="amountRange" type="range" min="1" max="12" step="1" value="3" aria-label="Monto"/>
                <div class="scale">
                  <span>$5k</span><span>$10k</span><span>$20k</span><span>$35k</span><span>$50k</span><span>$75k</span>
                </div>
                <div class="progress" aria-hidden="true"><i id="progressFill"></i></div>
              </div>
            </div>

            <div class="note">
              <b>C√≥mo se activa:</b> seleccion√°s tu escala ‚Üí gener√°s tu c√≥digo ‚Üí reclam√°s por WhatsApp o entr√°s directo.
              <br/><br/>
              <span style="color:var(--muted2)">*</span> El beneficio se acredita con tu pr√≥xima carga seg√∫n condiciones vigentes.
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="panel">
        <div class="inner summaryCard">
          <div class="big">
            <h2>Tu beneficio listo para activar</h2>
            <div class="desc">Confirm√° para que quede registrado. Si prefer√≠s, entr√° directo a la plataforma.</div>

            <div class="line">
              <div>Usuario: <b id="userLabel">‚Äî</b></div>
              <div>Beneficio: <b id="benefitLabel">+20%</b></div>
              <div>M√≠nimo: <b id="minLabel">$ 10.000</b></div>
            </div>

            <div class="codeBox">
              C√≥digo: <b id="codeLabel">‚Äî</b><br/>
              Fecha/Hora: <b id="tsLabel">‚Äî</b>
            </div>
          </div>

          <div class="note">
            <b>Tip operativo:</b> para usuarios fuertes, empuj√° a <b>Pro</b> o <b>Max</b>.
            <br/><br/>
            Si ya us√≥ la chance del d√≠a, el sistema lo bloquea autom√°ticamente.
          </div>
        </div>
      </aside>
    </div>
  </div>
</div>

<!-- Dock -->
<div class="dock">
  <div class="dockInner">
    <button class="btn ghost" id="btnGenerate">üßæ Generar c√≥digo</button>
    <button class="btn claim" id="btnClaim" disabled>üì≤ Reclamar por WhatsApp</button>
    <button class="btn enter" id="btnEnter">üéÆ Entrar a la plataforma</button>
  </div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="modalHead">
      <h3 id="mTitle">‚úÖ Beneficio generado</h3>
      <div class="x" id="mClose" aria-label="Cerrar">‚úñ</div>
    </div>
    <div class="modalBody">
      <div class="modalRow"><div class="k">Beneficio</div><div class="v" id="mBenefit">‚Äî</div></div>
      <div class="modalRow"><div class="k">M√≠nimo</div><div class="v" id="mMin">‚Äî</div></div>
      <div class="modalRow"><div class="k">C√≥digo</div><div class="v" id="mCode">‚Äî</div></div>
      <div class="modalRow"><div class="k">Fecha/Hora</div><div class="v" id="mTs">‚Äî</div></div>

      <div class="modalActions">
        <button class="btn claim" id="mWa">üì≤ Reclamar por WhatsApp</button>
        <button class="btn enter" id="mEnter">üéÆ Entrar</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */

// Link √∫nico
const ENTER_URL = "https://bet300.biz";

// WhatsApp gen√©ricos (reemplaz√°s despu√©s)
const WP_NUMBERS = {
  pc1: "5491100000000",
  pc2: "5491100000000",
  pc3: "5491100000000",
  pc4: "5491100000000",
  pc5: "5491100000000"
};

function normalizeWP(n){
  const s = String(n||"").replace(/[^\d+]/g,"");
  if(!s) return "";
  return s.startsWith("+") ? s.slice(1) : s;
}

// params: ?pc=1..5 (NO SE MUESTRA EN HEADER) y opcional ?user=Nombre
const params = new URLSearchParams(location.search);
const pcParam = (params.get("pc")||"1").trim();
const pcMatch = /^[1-5]$/.test(pcParam) ? pcParam : "1";
const pcKey = "pc"+pcMatch;
const USER = (params.get("user")||"").trim();

document.getElementById("userLabel").textContent = USER ? USER : "‚Äî";

const WP = normalizeWP(WP_NUMBERS[pcKey] || "");

// botones enter
document.getElementById("btnEnter").onclick = ()=> window.open(ENTER_URL, "_blank", "noopener");
document.getElementById("mEnter").onclick   = ()=> window.open(ENTER_URL, "_blank", "noopener");

/* ================= BENEFICIO PROGRESIVO ================= */
const SCALE = [
  {min:  5000, pct: 20, tier:"base"},
  {min:  8000, pct: 22, tier:"base"},
  {min: 10000, pct: 25, tier:"base"},
  {min: 15000, pct: 30, tier:"pro"},
  {min: 20000, pct: 35, tier:"pro"},
  {min: 25000, pct: 38, tier:"pro"},
  {min: 35000, pct: 42, tier:"max"},
  {min: 50000, pct: 45, tier:"max"},
  {min: 75000, pct: 50, tier:"max"},
  {min:100000, pct: 50, tier:"max"},
  {min:150000, pct: 50, tier:"max"},
  {min:200000, pct: 50, tier:"max"},
];

const amountRange = document.getElementById("amountRange");
const kAmount = document.getElementById("kAmount");
const kBenefit = document.getElementById("kBenefit");
const kHint = document.getElementById("kHint");
const benefitLabel = document.getElementById("benefitLabel");
const minLabel = document.getElementById("minLabel");
const progressFill = document.getElementById("progressFill");
const tierPills = document.getElementById("tierPills");

let selectedIndex = Number(amountRange.value||3);

function money(n){ return "$ " + Number(n).toLocaleString("es-AR"); }
function tierText(t){
  if(t==="base") return "Nivel Base ¬∑ Activaci√≥n r√°pida";
  if(t==="pro")  return "Nivel Pro ¬∑ Mejor retorno";
  return "Nivel Max ¬∑ Beneficio alto";
}
function setActiveTier(t){
  [...tierPills.querySelectorAll(".tier")].forEach(el=>{
    el.classList.toggle("active", el.dataset.tier===t);
  });
}
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

function updateUI(){
  selectedIndex = clamp(selectedIndex, 1, SCALE.length);
  const item = SCALE[selectedIndex-1];

  kAmount.textContent = money(item.min);
  kBenefit.textContent = `+${item.pct}%`;
  kHint.textContent = tierText(item.tier);

  benefitLabel.textContent = `+${item.pct}%`;
  minLabel.textContent = money(item.min);

  const pct = Math.round((selectedIndex / SCALE.length) * 100);
  progressFill.style.width = pct + "%";

  setActiveTier(item.tier);
}

amountRange.max = String(SCALE.length);
amountRange.addEventListener("input", ()=>{
  selectedIndex = Number(amountRange.value);
  updateUI();
});

tierPills.addEventListener("click", (e)=>{
  const t = e.target?.dataset?.tier;
  if(!t) return;
  const idx = SCALE.findIndex(x=>x.tier===t);
  if(idx>=0){
    selectedIndex = idx+1;
    amountRange.value = String(selectedIndex);
    updateUI();
    toast(`Escala ${t.toUpperCase()} seleccionada`);
  }
});

updateUI();

/* ================= 1 CHANCE + C√ìDIGO ================= */
const SALT = "bet300-benefit-v2";
function todayKey(){
  const n=new Date();
  return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
}
function tsString(d=new Date()){
  const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}
function ensureDeviceId(){
  let id = localStorage.getItem("device_id");
  if(!id){
    id = (crypto.randomUUID?.() || `${Date.now()}-${Math.random().toString(36).slice(2,10)}`);
    localStorage.setItem("device_id", id);
  }
  return id;
}
const DEVICE_ID = ensureDeviceId();

async function sha256hex(msg){
  const enc = new TextEncoder().encode(msg);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function makeCode(min, pct){
  const base = `${DEVICE_ID}|${todayKey()}|pc:${pcMatch}|min:${min}|pct:${pct}|${SALT}`;
  const hex = await sha256hex(base);
  return hex.slice(0,10).toUpperCase();
}
function dailyResetIfNeeded(){
  const d = localStorage.getItem("benefit_date");
  const t = todayKey();
  if(!d){
    localStorage.setItem("benefit_date", t);
    return;
  }
  if(d !== t){
    localStorage.setItem("benefit_date", t);
    localStorage.removeItem("benefit_done");
    localStorage.removeItem("benefit_payload");
  }
}
dailyResetIfNeeded();

/* ================= SONIDO ================= */
let soundOn = true;
const soundToggle = document.getElementById("soundToggle");
const soundState  = document.getElementById("soundState");

const AudioKit = (()=> {
  const Ctx = window.AudioContext || window.webkitAudioContext;
  const ctx = new Ctx();
  let unlocked=false;
  function unlock(){ if(!unlocked){ ctx.resume().catch(()=>{}); unlocked=true; } }
  function blip(freq=900,dur=0.05,vol=0.05,type="sine"){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.value=0;
    o.connect(g).connect(ctx.destination);
    const t=ctx.currentTime;
    g.gain.linearRampToValueAtTime(vol, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.start(t); o.stop(t+dur);
  }
  function ok(){ [660,880,1100].forEach((f,i)=>setTimeout(()=>blip(f,0.08,0.06,"triangle"), i*90)); }
  function no(){ blip(220,0.10,0.06,"square"); }
  return {unlock, ok, no};
})();
document.addEventListener("click", ()=>AudioKit.unlock(), {once:true});
soundToggle.addEventListener("click", ()=>{
  soundOn=!soundOn;
  soundState.textContent = soundOn ? "ON" : "OFF";
});

/* ================= GENERATE / CLAIM / MODAL ================= */
const btnGenerate = document.getElementById("btnGenerate");
const btnClaim = document.getElementById("btnClaim");

const codeLabel = document.getElementById("codeLabel");
const tsLabel = document.getElementById("tsLabel");

const modal = document.getElementById("modal");
const mClose = document.getElementById("mClose");
const mBenefit = document.getElementById("mBenefit");
const mMin = document.getElementById("mMin");
const mCode = document.getElementById("mCode");
const mTs = document.getElementById("mTs");
const mWa = document.getElementById("mWa");

function openModal(){ modal.classList.add("show"); }
function closeModal(){ modal.classList.remove("show"); }
mClose.onclick = closeModal;
modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });

function buildMessage(payload){
  const name = USER ? ` ${USER}` : "";
  return [
    `Hola${name}, te habla BET300 üëã`,
    `Te activ√© un Beneficio Progresivo: +${payload.pct}% con carga m√≠nima ${money(payload.min)}.`,
    `C√≥digo: ${payload.code} ¬∑ ${payload.ts}`,
    `Link: ${ENTER_URL}`
  ].join("\n");
}

function doWA(payload){
  if(!WP){
    alert("WhatsApp no configurado (dej√© gen√©rico). Luego complet√°s WP_NUMBERS.");
    return;
  }
  const msg = buildMessage(payload);
  location.href = `https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;
}

function setPayloadUI(payload){
  codeLabel.textContent = payload.code;
  tsLabel.textContent = payload.ts;

  mBenefit.textContent = `+${payload.pct}%`;
  mMin.textContent = money(payload.min);
  mCode.textContent = payload.code;
  mTs.textContent = payload.ts;

  btnClaim.disabled = false;
  btnClaim.onclick = ()=> doWA(payload);
  mWa.onclick = ()=> doWA(payload);
}

function restoreIfAny(){
  const done = localStorage.getItem("benefit_done")==="1";
  const raw = localStorage.getItem("benefit_payload");
  if(done && raw){
    try{
      const payload = JSON.parse(raw);
      setPayloadUI(payload);
      document.getElementById("luxTag").textContent = "‚úÖ Chance usada hoy";
    }catch{}
  }
}
restoreIfAny();

btnGenerate.addEventListener("click", async ()=>{
  if(localStorage.getItem("benefit_done")==="1"){
    if(soundOn) AudioKit.no();
    toast("Ya usaste tu chance de hoy");
    openModalAlreadyUsed();
    return;
  }

  const item = SCALE[selectedIndex-1];
  const code = await makeCode(item.min, item.pct);
  const ts = tsString(new Date());

  const payload = {min:item.min, pct:item.pct, code, ts, pc:pcMatch, user: USER || ""};

  localStorage.setItem("benefit_done","1");
  localStorage.setItem("benefit_payload", JSON.stringify(payload));

  document.getElementById("luxTag").textContent = "‚úÖ Chance usada hoy";
  if(soundOn) AudioKit.ok();

  setPayloadUI(payload);
  openModal();
});

function openModalAlreadyUsed(){
  const raw = localStorage.getItem("benefit_payload");
  if(raw){
    try{
      const payload = JSON.parse(raw);
      setPayloadUI(payload);
      openModal();
      return;
    }catch{}
  }
  alert("Ya usaste tu chance de hoy.");
}

/* ================= COUNTDOWN ================= */
function endOfDay(){
  const n=new Date();
  return new Date(n.getFullYear(), n.getMonth(), n.getDate(), 23,59,0,0).getTime();
}
function tickCountdown(){
  const ms = endOfDay() - Date.now();
  const total = Math.max(0, Math.floor(ms/1000));
  const h=Math.floor(total/3600), m=Math.floor((total%3600)/60), s=total%60;
  document.getElementById("countdown").textContent =
    h>0 ? `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` :
          `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
tickCountdown();
setInterval(tickCountdown, 1000);

/* ================= TOAST ================= */
const toastEl = document.getElementById("toast");
let toastTO=null;
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastTO);
  toastTO = setTimeout(()=>toastEl.classList.remove("show"), 1400);
}

/* ================= PART√çCULAS ================= */
(function particles(){
  const c = document.getElementById("fx");
  const ctx = c.getContext("2d");
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

  let W=0,H=0, pts=[];
  function resize(){
    W = Math.floor(innerWidth * DPR);
    H = Math.floor(innerHeight * DPR);
    c.width = W; c.height = H;
    pts = Array.from({length: 76}, ()=>({
      x: Math.random()*W,
      y: Math.random()*H,
      r: (Math.random()*1.7 + 0.45)*DPR,
      a: Math.random()*0.30 + 0.06,
      vx: (Math.random()*0.20 + 0.05)*DPR,
      vy: (Math.random()*0.18 + 0.04)*DPR
    }));
  }
  resize();
  addEventListener("resize", ()=>{
    clearTimeout(window.__pTo);
    window.__pTo = setTimeout(resize, 140);
  });

  function draw(){
    ctx.clearRect(0,0,W,H);

    const g1 = ctx.createRadialGradient(W*0.22,H*0.08,0, W*0.22,H*0.08, Math.max(W,H)*0.7);
    g1.addColorStop(0, "rgba(255,45,45,.10)");
    g1.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g1; ctx.fillRect(0,0,W,H);

    const g2 = ctx.createRadialGradient(W*0.88,H*0.10,0, W*0.88,H*0.10, Math.max(W,H)*0.65);
    g2.addColorStop(0, "rgba(245,211,123,.08)");
    g2.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g2; ctx.fillRect(0,0,W,H);

    for(const p of pts){
      p.x += p.vx; p.y += p.vy;
      if(p.x>W+20) p.x=-20;
      if(p.y>H+20) p.y=-20;

      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle = `rgba(245,211,123,${p.a})`;
      ctx.fill();
    }
    requestAnimationFrame(draw);
  }
  draw();
})();

/* ================= LOGO FALLBACK (si no carga) ================= */
(function logoFallback(){
  const img = document.getElementById("logoImg");
  const box = document.getElementById("logoBox");
  img.addEventListener("error", ()=> box.classList.add("is-fallback"));
})();
</script>
</body>
</html>
